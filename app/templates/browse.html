{% extends "base.html" %}

{% block content %}
<div class="container">

    {% if route %}
    <ul class="breadcrumb">
        <li><a href="{{ url_for("main.root")}}">root</a>
            {% for string in route %}
        <li><a>{{string}}</a></li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if (folders|length > 0) or (files|length > 0) %}
    <a href="/browse/{{ parent_url }}">
        <div class="panel panel-info">
            <div class="panel-heading">
                <span class="glyphicon glyphicon glyphicon-arrow-left" style="margin-right:10px;"></span>
                Back
            </div>
        </div>
    </a>
    {% endif %}
    <div class="action-panel">
        <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">NEW
            FOLDER
        </button>
        <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#uploadModal">UPLOAD
        </button>
    </div>
    <br>
    <br>

    {% if (folders|length == 0) and (files|length == 0) and not Error404 %}
    <a href="/browse/{{ parent_url }}">
        <div class="panel panel-warning">
            <div class="panel-heading">
                <span class="glyphicon glyphicon glyphicon-arrow-left" style="margin-right:10px;"></span>
                Nothing here. Click to go back.
            </div>
        </div>
    </a>
    {% endif %}

    {% if Error404 %}
    <a href="javascript:history.back()">
        <div class="panel panel-danger">
            <div class="panel-heading">
                <span class="glyphicon glyphicon glyphicon-arrow-left" style="margin-right:10px;"></span>
                Error 404, not found.
            </div>
            <div class="panel-body">
                The file was deleted or didn't exist at all.
                <br>
                However, mister <strong>{{ClientIP}}</strong>, this incident was logged.
            </div>
        </div>
    </a>
    {% endif %}

    {% if folders|length > 0 %}
    {% for folder in folders %}
    <div class="panel panel-primary">
        <div class="panel-heading">
            <a class="white-link" href={{ url_for("main.browse", path=BASE_PATH + "/"+folder)}}>
            <span class="glyphicon glyphicon-folder-open" style="margin-right:10px;"></span>
            {{folder}}
            </a>
            <a class="white-link" href={{ url_for("main.remove" , path=BASE_PATH+"/"+folder)}}>

            <div class="download">
                <span class="glyphicon glyphicon-remove" style="margin-right:10px;"></span>
                Remove
            </div>
            </a>

        </div>
    </div>
    {% endfor%}

    {% endif %}

    {% if files|length > 0 %}
    {% for file in files %}
    <div class="panel panel-primary">
        <div class="panel-body">
            <a href={{ url_for("main.browse", path=BASE_PATH+"/"+file)}}>
            <span class="{{classmaker(file)}}" style="margin-right:10px;"></span>
            {{file}}
            </a>
            <a href={{ url_for("main.download" , path=BASE_PATH+"/"+file)}}>

            <div class="download">
                <span class="glyphicon glyphicon-cloud-download" style="margin-right:10px;"></span>
                Download
            </div>
            </a>
            <a href={{ url_for("main.remove" , path=BASE_PATH+"/"+file)}}>

            <div class="download">
                <span class="glyphicon glyphicon-remove" style="margin-right:10px;"></span>
                Remove
            </div>
            </a>
        </div>
    </div>
    {% endfor %}
    {% endif %}
    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close"
                            data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">NEW FOLDER</h4>
                </div>
                <div class="modal-body">


                    <form method="POST">
                        {{ form.csrf_token }}
                        {{ form.hidden_tag() }}
                        {{ form.folder.label }} {{ form.folder(size=20) }} {{form.submit()}}
                    </form>
                </div>


                <div
                        class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close
                    </button>

                </div>
            </div>

        </div>
    </div>
    <div id="uploadModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close"
                            data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Upload</h4>
                </div>
                <div class="modal-body">
                    <form id="upload-form" method="POST" enctype="multipart/form-data"
                          action="{{ url_for('main.browse', path= BASE_PATH) }}">
                        <input id="fileupload" type="file" name="files">
                        <input id="upload-file-btn" type="submit">
                    </form>

                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" role="progressbar" aria-valuenow="60"
                             aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%
                        </div>
                    </div>

                </div>
                <div
                        class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>
</div>
<script>
$(function() {
    $('#upload-file-btn').click(function(event) {
        event.preventDefault();
        var form = $('#upload-form')[0];
        var form_data = new FormData(form);
        $.ajax({
        xhr: function(){
        //upload Progress
        var xhr = new window.XMLHttpRequest();
        if (xhr.upload) {
            xhr.upload.addEventListener('progress', function(event) {
                var percent = 0;
                var position = event.loaded || event.position;
                var total = event.total;
                if (event.lengthComputable) {
                    percent = Math.ceil(position / total * 100);
                    console.log(percent)
                    $('#progress-bar').attr('aria-valuenow', percent).css('width', percent + '%').text(percent + '%');
                }
                //update progressbar
            }, true);
        }
        return xhr;
    },
            type: 'POST',
            url: '/browse/{{BASE_PATH}}',
            data: form_data,
            header: {'Content-Length': form_data.length},
            contentType: false,
            cache: false,
            processData: false,
            success: function(data){
                if (data.status == 1){
                    window.location.href = this.url
                }
            }
        });
    });
});

</script>
{% endblock %}
